<div class="card mb-3 shadow opinion-panel">
  <div class="card-header">
    Parere
  </div>
  <div class="card-body">

    <% if policy(RequestOpinion).create? || policy(RequestOpinion).show? %>
      <%= render "request_opinions/req_op" %>
    <% end %>

    <% user_asked_for_opinion = @invitation.users_who_was_asked_for_an_opinion.include?(current_user.id) %>
    <% if policy(Opinion).express? || user_asked_for_opinion %>
      <div class="row border-bottom mb-3 pb-3">
        <div class="col-md-12">
          <% if user_asked_for_opinion %>
            <div class="warning-1 mb-3">
              <i class="fas fa-exclamation-triangle mr-1"></i>
              <% requester_ids = @invitation.request_opinions.joins(groups: :users).where('users.id' => current_user.id).pluck('request_opinions.user_id') %>
              <% if (arr = requester_ids.compact.uniq).any? %>
                <% if arr.size==1 %>
                  <%= "#{User.find(arr.first).display_name} ha richiesto esplicitamente il tuo parere" %>
                <% else %>
                  <%= "#{User.find(arr).map(&:display_name).join(', ')} hanno richiesto esplicitamente il tuo parere" %>
                <% end %>
              <% else %>
                Il Presidente ha richiesto esplicitamente il tuo parere
              <% end %>
            </div>
          <% end %>
          <p class="title">Il tuo parere</p>
          <%= form_with(model: @opinion) do |form| %>
            <%= form.hidden_field :invitation_id %>
            <div class="form-row">
              <div class="col">
                <%= form.collection_select :selection, Opinion.choices, :first, ->(e){ t("opinion.#{e.first}") }, {prompt: true}, class: "form-control"  %>
              </div>
              <div class="col-auto">
                <%= form.submit "Salva", class: "btn btn-primary" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>


    <% if policy(Opinion).show? && @other_opinions.any? %>
      <div class="row border-bottom mb-3 pb-3">
        <div class="col-md-12">
          <p class="title">Pareri di altri</p>
          <ul class="other-opinions">
            <% @other_opinions.each do |op| %>
            <li>
              <strong><%= op.user.display_name %></strong>
              (<%= @invitation.request_opinions.map(&:groups).flatten.uniq.keep_if{|gr| gr.users.include?(op.user)}.map(&:name).join(',') %>):
              <em><%= t op.selection, scope: :opinion %></em>
            </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>


    <% if policy(Comment).show? %>
      <div class="row">
        <div class="col-md-12">
          <p class="title">Commenti</p>
          <div class="panel-chat">
            <ul class="chat">
              <% @comments.each do |comment| %>
                <%= render 'chat_comment', comment: comment %>
              <% end %>
            </ul>

            <% if policy(Comment).create? %>
              <%= form_with(model: @comment) do |form| %>
                <%= form.hidden_field :invitation_id %>
                <div class="form-group">
                  <%= form.label :content, "Aggiungi un commento:" %>
                  <%= form.text_area :content, class: "form-control"  %>
                </div>

                <div class="actions">
                  <%= form.submit "Invia", class: "btn btn-primary" %>
                  <span class="ajax-submit-feedback" id="text-after-submit-comment-panel"></span>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

  </div>
</div>
